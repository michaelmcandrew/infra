---
- name: install packages
  apt:
    name:
      - acl
      - drush
      - git
      - mysql-server
      - mysql-client
      - nginx
      - phpmyadmin
      - php-gettext
      - php-soap
      - php5-common
      - php5-curl
      - php5-fpm
      - php5-gd
      - php5-mcrypt
      - php5-mysql
      - php5-imap
      - php5-intl
      - python-mysqldb
    state: latest
    update_cache: true
    cache_valid_time: 21600 # six hours
  become: true
- name: ensure services are running and enabled on boot
  become: true
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items:
  - nginx
  - mysql
  - php5-fpm
- name: download composer
  script: install-composer.sh
  args:
    creates: /usr/local/bin/composer
- name: get latest scout
  git:
    repo: https://github.com/michaelmcandrew/scout
    dest: ~/src/scout
    update: yes
    accept_hostkey: yes
- name: get latest cv
  git:
    repo: https://github.com/michaelmcandrew/cv
    dest: ~/src/cv
    update: yes
    accept_hostkey: yes
    version: pop
- name: install cv
  shell: composer install
  args:
    creates: ~/src/cv/vendor/autoload.php
    chdir: ~/src/cv
- name: create /var/www
  file:
    name: /var/www
    state: directory
  become: true
- name: create /var/repos
  file:
    name: /var/repos
    state: directory
  become: true
- name: link scout to /usr/local/bin
  file:
    name: /usr/local/bin/scout
    src: /home/ubuntu/src/scout/scout
    state: link
  become: true
- name: link cv to /usr/local/bin
  file:
    name: /usr/local/bin/cv
    src: /home/ubuntu/src/cv/bin/cv
    state: link
  become: true
- name: create .scout directory
  file:
    name: ~/.scout
    state: directory
- name: ubuntu user can muck around in standard places
  shell: setfacl -m user:ubuntu:rwx /var/www /var/repos /etc/nginx/sites-enabled /etc/nginx/sites-available
  become: true
- name: Check that .my.cnf exists
  stat: path=~/.my.cnf
  register: my_cnf
- name: set mysql password
  local_action: command apg -m 20 -M NCL -a 1 -n 1
  register: password
  when: not my_cnf.stat.exists
- name: set root mysql password
  mysql_user:
    login_user: root
    user: root
    password: password.stdout
  when: not my_cnf.stat.exists
- name: create ~/.my.cnf file
  template:
    src: my.cnf
    dest: ~/.my.cnf
  when: not my_cnf.stat.exists
